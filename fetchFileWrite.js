// const fs = require('fs');
import fs from 'fs/promises'
import fetch, {Headers} from "node-fetch"
import appProps from  'appProps.json' assert { type: "json" };

const baseUrl = 'https://api.myanimelist.net/'
const apiVer = 'v2/'
const firstEP = 'anime/10357?fields=rank,mean,alternative_titles'
let username = 'nugen_exe'
// username = 'therealmccree'
// username = 'bambibutt'
const usersEP = `users/${username}/animelist?`


//curl 'https://api.myanimelist.net/v2/ \

// https://github.com/SuperMarcus/myanimelist-api-specification#sortingmethodenum
// https://myanimelist.net/apiconfig/references/api/v2#operation/users_user_id_animelist_get


async function main () {
	let genreMap = new Map()
	const queryParams = {
		fields: 'list_status,start_date,mean,alternative_titles,genres,studios',
		status: 'completed',
		limit: '100',
		nsfw: 'true'
	}
	let url = `${baseUrl}${apiVer}${usersEP}${'' + new URLSearchParams(queryParams)}`
	const headers = new Headers({
		'X-MAL-CLIENT-ID': appProps.mal.malHeaders
	})


	let foo = []
	
	let count = 0
	do {
		console.log(count+'timeStart')
		console.time(count)
		let response = await fetch(url, { headers })
		console.log(count+'timeLog1')
		console.timeLog(count)
	
		let responseJSON = await response.json()
		
		// console.log(JSON.stringify(responseJSON))
		foo = foo.concat(responseJSON.data)
		

		// let count2 = 0;
		// responseJSON.data.forEach(e => {
		// 	count2++
		// 	console.log(count2 + '  ' + e.node.title)
		// })
		
		
		// console.log(genreMap)

	
	
		console.log(count+'timeEnd')
		console.timeEnd(count)

		url = responseJSON.paging.next

		count++
		// if(count > 2) break
	} while(url !== undefined)

	await fs.writeFile('./nugen_exe.json', JSON.stringify(foo), err => {
		if (err) {
			console.error(err);
		}
	});


}


console.log('~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~')
console.log('~~~~~~~~~~~~~~~~~~~~')
console.log('~~~~~~~~~~~~~~~~~~~~')
console.log('~~~~~~~~~~~~~~~~~~~~')
console.log('~~~~~~~~~~~~~~~~~~~~')
console.log('~~~~~~~~~~~~~~~~~~~~')
main()


